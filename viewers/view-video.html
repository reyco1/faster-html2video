<!DOCTYPE html>
<html>
<head>
    <title>WebM Video Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            font-family: Arial, sans-serif;
        }
        .container {
            text-align: center;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        video {
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info {
            margin-top: 20px;
            color: #666;
        }
        .video-selector {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .video-selector label {
            font-weight: bold;
            margin-right: 10px;
            color: #333;
        }
        select {
            padding: 8px 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            min-width: 300px;
        }
        select:hover {
            border-color: #999;
        }
        .metadata {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .metadata h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }
        .metadata table {
            width: 100%;
            border-collapse: collapse;
        }
        .metadata td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .metadata td:first-child {
            font-weight: bold;
            color: #555;
            width: 40%;
        }
        .metadata td:last-child {
            color: #333;
        }
        .loading {
            color: #999;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            background: #fee;
            border-radius: 4px;
            margin: 10px 0;
        }
        .no-video {
            padding: 40px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            color: #666;
            margin: 20px 0;
        }
        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
        }
        .refresh-btn:hover {
            background: #45a049;
        }
        .registry-info {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebM Video Viewer</h1>
        
        <div class="video-selector">
            <label for="videoSelect">Select Video:</label>
            <select id="videoSelect">
                <option value="">Loading videos...</option>
            </select>
            <button class="refresh-btn" onclick="loadVideoRegistry()">ðŸ”„ Refresh</button>
            <div class="registry-info" id="registryInfo"></div>
        </div>
        
        <div id="videoContainer" style="display: none;">
            <video id="videoPlayer" controls autoplay loop>
                Your browser does not support the video tag.
            </video>
            <div class="info">
                The checkered background shows the transparency
            </div>
        </div>
        
        <div id="noVideo" class="no-video" style="display: none;">
            <p>No video selected. Please choose a video from the dropdown above.</p>
            <p style="font-size: 14px; margin-top: 20px;">
                If you've just generated a video, click the Refresh button to update the list.
            </p>
        </div>
        
        <div class="metadata" id="metadata" style="display: none;">
            <h2>Video Generation Metadata</h2>
            <div class="loading">Loading metadata...</div>
        </div>
    </div>

    <script>
        const videoSelect = document.getElementById('videoSelect');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoContainer = document.getElementById('videoContainer');
        const noVideoDiv = document.getElementById('noVideo');
        const metadataDiv = document.getElementById('metadata');
        const registryInfo = document.getElementById('registryInfo');
        
        let availableVideos = [];
        
        async function loadVideoRegistry() {
            try {
                // Show loading state
                videoSelect.innerHTML = '<option value="">Loading videos...</option>';
                registryInfo.textContent = 'Loading registry...';
                
                // Try to load the video registry
                const response = await fetch('../video-registry.json');
                
                if (!response.ok) {
                    throw new Error('Registry not found');
                }
                
                const registry = await response.json();
                availableVideos = [];
                
                // Process videos from registry
                if (registry.videos && registry.videos.length > 0) {
                    for (const video of registry.videos) {
                        availableVideos.push({
                            path: '../' + video.path,
                            metadataPath: '../' + video.metadataPath,
                            filename: video.filename,
                            directory: video.directory,
                            label: `${video.filename} (${video.directory})`,
                            generatedAt: video.generatedAt,
                            resolution: video.resolution,
                            duration: video.duration,
                            fileSize: video.fileSize
                        });
                    }
                    
                    // Update registry info
                    const lastUpdated = new Date(registry.lastUpdated);
                    registryInfo.textContent = `Registry updated: ${lastUpdated.toLocaleString()} â€¢ ${registry.videos.length} videos`;
                } else {
                    registryInfo.textContent = 'No videos in registry';
                }
                
                updateVideoDropdown();
                
            } catch (error) {
                console.error('Failed to load registry:', error);
                
                // Fall back to checking known locations
                registryInfo.textContent = 'Registry not found, checking known locations...';
                await loadVideoListFallback();
            }
        }
        
        async function loadVideoListFallback() {
            // Fallback: check known files in common directories
            const videoLocations = [
                { path: '../outputs/', label: 'Outputs Directory' },
                { path: '../', label: 'Root Directory' },
                { path: '../examples/', label: 'Examples Directory' }
            ];
            
            const knownFiles = [
                'output.webm',
                'highenergy.webm',
                'highenergy-test.webm',
                'test-animation-highenergy.webm',
                'bounce-demo.webm'
            ];
            
            availableVideos = [];
            
            for (const location of videoLocations) {
                for (const file of knownFiles) {
                    try {
                        const videoPath = location.path + file;
                        const response = await fetch(videoPath, { method: 'HEAD' });
                        if (response.ok) {
                            availableVideos.push({
                                path: videoPath,
                                filename: file,
                                label: `${file} (${location.label})`,
                                metadataPath: videoPath.replace('.webm', '.metadata.json'),
                                directory: location.label
                            });
                        }
                    } catch (e) {
                        // File doesn't exist, continue
                    }
                }
            }
            
            updateVideoDropdown();
            registryInfo.textContent = `Found ${availableVideos.length} videos (fallback mode)`;
        }
        
        function updateVideoDropdown() {
            videoSelect.innerHTML = '';
            
            if (availableVideos.length === 0) {
                videoSelect.innerHTML = '<option value="">No videos found</option>';
                noVideoDiv.style.display = 'block';
                return;
            }
            
            videoSelect.innerHTML = '<option value="">-- Select a video --</option>';
            
            // Group videos by directory
            const grouped = {};
            availableVideos.forEach(video => {
                const dir = video.directory || 'Unknown';
                if (!grouped[dir]) grouped[dir] = [];
                grouped[dir].push(video);
            });
            
            // Add videos to dropdown, grouped by directory
            Object.keys(grouped).sort().forEach(dir => {
                if (Object.keys(grouped).length > 1) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = dir;
                    
                    grouped[dir].forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.path;
                        option.textContent = video.filename;
                        option.dataset.metadataPath = video.metadataPath;
                        
                        // Add additional info if available
                        if (video.generatedAt) {
                            const date = new Date(video.generatedAt);
                            option.textContent += ` (${date.toLocaleDateString()})`;
                        }
                        
                        optgroup.appendChild(option);
                    });
                    
                    videoSelect.appendChild(optgroup);
                } else {
                    // Only one directory, don't use optgroup
                    grouped[dir].forEach(video => {
                        const option = document.createElement('option');
                        option.value = video.path;
                        option.textContent = video.label;
                        option.dataset.metadataPath = video.metadataPath;
                        videoSelect.appendChild(option);
                    });
                }
            });
            
            // Auto-select first video if only one available
            if (availableVideos.length === 1) {
                videoSelect.selectedIndex = 1;
                loadSelectedVideo();
            }
        }
        
        async function loadSelectedVideo() {
            const selectedPath = videoSelect.value;
            
            if (!selectedPath) {
                videoContainer.style.display = 'none';
                noVideoDiv.style.display = 'block';
                metadataDiv.style.display = 'none';
                return;
            }
            
            // Load video
            videoContainer.style.display = 'block';
            noVideoDiv.style.display = 'none';
            videoPlayer.src = selectedPath;
            
            // Load metadata
            const selectedOption = videoSelect.selectedOptions[0];
            const metadataPath = selectedOption.dataset.metadataPath;
            
            metadataDiv.style.display = 'block';
            await loadMetadata(metadataPath);
        }
        
        async function loadMetadata(metadataPath) {
            try {
                const response = await fetch(metadataPath);
                if (!response.ok) {
                    throw new Error('Metadata file not found');
                }
                
                const metadata = await response.json();
                
                const formatTime = (seconds) => {
                    if (seconds < 60) {
                        return `${seconds.toFixed(1)} seconds`;
                    }
                    const minutes = Math.floor(seconds / 60);
                    const secs = (seconds % 60).toFixed(1);
                    return `${minutes}m ${secs}s`;
                };
                
                const formatSize = (mb) => {
                    if (mb < 1) {
                        return `${(mb * 1024).toFixed(0)} KB`;
                    }
                    return `${mb.toFixed(1)} MB`;
                };
                
                const html = `
                    <h2>Video Generation Metadata</h2>
                    <table>
                        <tr>
                            <td>Generation Time:</td>
                            <td>${formatTime(metadata.generationTime)}</td>
                        </tr>
                        <tr>
                            <td>Processing Speed:</td>
                            <td>${metadata.processingSpeed.toFixed(1)} fps</td>
                        </tr>
                        <tr>
                            <td>Total Frames:</td>
                            <td>${metadata.totalFrames} frames</td>
                        </tr>
                        <tr>
                            <td>Captured Frames:</td>
                            <td>${metadata.capturedFrames} frames</td>
                        </tr>
                        <tr>
                            <td>Skipped Frames:</td>
                            <td>${metadata.skippedFrames} frames</td>
                        </tr>
                        <tr>
                            <td>Video Duration:</td>
                            <td>${metadata.duration} seconds @ ${metadata.fps}fps</td>
                        </tr>
                        <tr>
                            <td>Video Resolution:</td>
                            <td>${metadata.width}x${metadata.height}</td>
                        </tr>
                        <tr>
                            <td>File Size:</td>
                            <td>${formatSize(metadata.fileSize)}</td>
                        </tr>
                        <tr>
                            <td>Codec:</td>
                            <td>${metadata.codec.toUpperCase()} with alpha channel</td>
                        </tr>
                        <tr>
                            <td>Quality (CRF):</td>
                            <td>${metadata.quality}</td>
                        </tr>
                        <tr>
                            <td>Generated:</td>
                            <td>${new Date(metadata.timestamp).toLocaleString()}</td>
                        </tr>
                    </table>
                `;
                
                metadataDiv.innerHTML = html;
                
            } catch (error) {
                metadataDiv.innerHTML = `
                    <h2>Video Generation Metadata</h2>
                    <div class="error">
                        No metadata available for this video
                    </div>
                `;
            }
        }
        
        // Event listeners
        videoSelect.addEventListener('change', loadSelectedVideo);
        
        // Load video registry on page load
        loadVideoRegistry();
        
        // Also check URL parameters for direct video loading
        const urlParams = new URLSearchParams(window.location.search);
        const videoPath = urlParams.get('video');
        if (videoPath) {
            // Wait for registry to load, then add direct link if needed
            setTimeout(() => {
                const exists = availableVideos.some(v => v.path === videoPath);
                if (!exists) {
                    availableVideos.push({
                        path: videoPath,
                        filename: videoPath.split('/').pop(),
                        label: videoPath.split('/').pop() + ' (Direct Link)',
                        metadataPath: videoPath.replace('.webm', '.metadata.json')
                    });
                    updateVideoDropdown();
                }
                videoSelect.value = videoPath;
                loadSelectedVideo();
            }, 1000);
        }
    </script>
</body>
</html>