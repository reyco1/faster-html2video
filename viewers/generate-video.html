<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast HTML2Video - Generate Video</title>
    <style>
        :root {
            --primary: #4CAF50;
            --primary-dark: #45a049;
            --secondary: #2196F3;
            --danger: #f44336;
            --warning: #ff9800;
            --bg: #f5f5f5;
            --card-bg: white;
            --text: #333;
            --text-muted: #666;
            --border: #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text: #fff;
            --text-muted: #ccc;
            --border: #444;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text);
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-control:disabled {
            background: var(--bg);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            text-align: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-full {
            width: 100%;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            font-size: 14px;
            color: var(--text-muted);
            text-align: center;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: var(--border);
            color: var(--text-muted);
        }

        .status-generating {
            background: var(--warning);
            color: white;
        }

        .status-completed {
            background: var(--primary);
            color: white;
        }

        .status-failed {
            background: var(--danger);
            color: white;
        }

        .video-preview {
            display: none;
            margin-top: 20px;
        }

        .video-preview video {
            width: 100%;
            max-height: 400px;
            border-radius: 10px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .metadata-display {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: var(--bg);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metadata-item {
            text-align: center;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .metadata-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            display: block;
        }

        .metadata-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 15px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg);
        }

        .file-upload-label:hover {
            border-color: var(--primary);
            background: var(--card-bg);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-radius: 50%;
            border-top: 2px solid currentColor;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .video-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .video-actions .btn {
            flex: 1;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
        üåô
    </div>

    <div class="container">
        <div class="header">
            <h1>üé¨ Fast HTML2Video</h1>
            <p>High-performance HTML animation to video converter with real-time progress</p>
        </div>

        <div class="alert alert-error" id="errorAlert"></div>
        <div class="alert alert-success" id="successAlert"></div>

        <div class="main-grid">
            <!-- Configuration Panel -->
            <div class="card">
                <h2>
                    ‚öôÔ∏è Configuration
                </h2>
                
                <form id="configForm">
                    <div class="form-group">
                        <label for="htmlFile">HTML File</label>
                        <select id="htmlFile" class="form-control" required>
                            <option value="">Loading HTML files...</option>
                        </select>
                        <div class="checkbox-group">
                            <input type="checkbox" id="uploadMode">
                            <label for="uploadMode">Upload custom HTML file</label>
                        </div>
                    </div>

                    <div class="form-group" id="uploadSection" style="display: none;">
                        <label>Upload HTML File</label>
                        <div class="file-upload">
                            <input type="file" id="fileUpload" accept=".html" />
                            <label for="fileUpload" class="file-upload-label">
                                üìé Click or drag HTML file here
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="duration">Duration (seconds)</label>
                            <input type="number" id="duration" class="form-control" value="5" min="1" max="300" required>
                        </div>
                        <div class="form-group">
                            <label for="fps">FPS</label>
                            <select id="fps" class="form-control">
                                <option value="24">24 fps</option>
                                <option value="30">30 fps</option>
                                <option value="60" selected>60 fps</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="width">Width</label>
                            <input type="number" id="width" class="form-control" value="1920" min="100" max="4096" required>
                        </div>
                        <div class="form-group">
                            <label for="height">Height</label>
                            <input type="number" id="height" class="form-control" value="1080" min="100" max="4096" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quality">Quality (CRF)</label>
                            <select id="quality" class="form-control">
                                <option value="18">Excellent (18)</option>
                                <option value="23" selected>Good (23)</option>
                                <option value="28">Fair (28)</option>
                                <option value="35">Draft (35)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="selector">CSS Selector</label>
                            <input type="text" id="selector" class="form-control" value="body" placeholder="body, #stage, .container">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableRecordingControl">
                            <label for="enableRecordingControl">Enable recording control from page</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="waitForStartSignal">
                            <label for="waitForStartSignal">Wait for start signal from page</label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full" id="generateBtn">
                        üé¨ Generate Video
                    </button>
                </form>
            </div>

            <!-- Progress & Preview Panel -->
            <div class="card">
                <h2>
                    üìä Progress & Preview
                </h2>

                <div id="statusContainer">
                    <div class="status-badge status-pending" id="statusBadge">Ready</div>
                    <p id="statusMessage">Select an HTML file and configure settings to start generation.</p>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Preparing...</div>
                </div>

                <div class="video-preview" id="videoPreview">
                    <video id="videoPlayer" controls autoplay loop muted>
                        Your browser does not support the video tag.
                    </video>
                    <div class="video-actions">
                        <button class="btn btn-secondary" onclick="downloadVideo()">
                            üíæ Download WebM
                        </button>
                        <button class="btn btn-primary" onclick="openInViewer()">
                            üëÅÔ∏è Open in Viewer
                        </button>
                        <button class="btn btn-danger" onclick="deleteVideo()">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                    
                    <!-- Conversion Options -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <h4 style="margin-bottom: 15px; color: var(--text);">üîÑ Convert to Other Formats</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="font-weight: 600; margin-right: 10px; color: var(--text);">Hardware Acceleration:</label>
                            <select id="convertAcceleration" style="padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
                                <option value="auto">üöÄ Auto (Recommended)</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="convertVideo('mp4')" id="convertMp4Btn">
                                üé¨ Convert to MP4
                            </button>
                            <button class="btn btn-secondary" onclick="convertVideo('mov')" id="convertMovBtn">
                                üéûÔ∏è Convert to QuickTime
                            </button>
                        </div>
                        <div id="conversionStatus" style="margin-top: 10px; display: none;">
                            <div style="width: 100%; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                                <div id="conversionProgress" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <p id="conversionMessage" style="margin: 5px 0; font-size: 14px; color: var(--text-muted);">Converting...</p>
                        </div>
                        <div id="conversionDownloads" style="margin-top: 10px; display: none;"></div>
                    </div>
                </div>

                <div class="metadata-display" id="metadataDisplay">
                    <h3>Generation Statistics</h3>
                    <div class="metadata-grid" id="metadataGrid"></div>
                </div>
            </div>
        </div>

        <!-- Recent Videos Section -->
        <div class="card">
            <h2>üìπ Recent Videos</h2>
            <div id="recentVideos">
                <p>Loading recent videos...</p>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let eventSource = null;
        let currentVideoPath = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadHtmlFiles();
            loadRecentVideos();
            setupEventListeners();
            loadTheme();
            loadHardwareCapabilities();
        });

        function setupEventListeners() {
            // Form submission
            document.getElementById('configForm').addEventListener('submit', handleFormSubmit);
            
            // Upload mode toggle
            document.getElementById('uploadMode').addEventListener('change', function() {
                document.getElementById('uploadSection').style.display = this.checked ? 'block' : 'none';
                document.getElementById('htmlFile').required = !this.checked;
            });

            // File upload
            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);

            // Recording control dependencies
            document.getElementById('enableRecordingControl').addEventListener('change', function() {
                document.getElementById('waitForStartSignal').disabled = !this.checked;
                if (!this.checked) {
                    document.getElementById('waitForStartSignal').checked = false;
                }
            });
        }

        async function loadHtmlFiles() {
            try {
                const response = await fetch('/api/html-files');
                const files = await response.json();
                
                const select = document.getElementById('htmlFile');
                select.innerHTML = '<option value="">-- Select HTML file --</option>';
                
                if (files.length === 0) {
                    select.innerHTML += '<option value="" disabled>No HTML files found</option>';
                    return;
                }

                // Group by directory
                const grouped = {};
                files.forEach(file => {
                    if (!grouped[file.directory]) {
                        grouped[file.directory] = [];
                    }
                    grouped[file.directory].push(file);
                });

                // Add options grouped by directory
                Object.keys(grouped).sort().forEach(dir => {
                    if (Object.keys(grouped).length > 1) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = dir.charAt(0).toUpperCase() + dir.slice(1);
                        
                        grouped[dir].forEach(file => {
                            const option = document.createElement('option');
                            option.value = file.path;
                            option.textContent = file.name;
                            optgroup.appendChild(option);
                        });
                        
                        select.appendChild(optgroup);
                    } else {
                        grouped[dir].forEach(file => {
                            const option = document.createElement('option');
                            option.value = file.path;
                            option.textContent = `${file.name} (${file.directory})`;
                            select.appendChild(option);
                        });
                    }
                });

            } catch (error) {
                showError('Failed to load HTML files: ' + error.message);
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('htmlFile', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    showSuccess(`File uploaded: ${result.filename}`);
                    
                    // Add to HTML files dropdown
                    const select = document.getElementById('htmlFile');
                    const option = document.createElement('option');
                    option.value = result.path;
                    option.textContent = `${result.filename} (uploaded)`;
                    option.selected = true;
                    select.appendChild(option);
                    
                    // Switch back to select mode
                    document.getElementById('uploadMode').checked = false;
                    document.getElementById('uploadSection').style.display = 'none';
                    
                } else {
                    showError(result.error || 'Upload failed');
                }
            } catch (error) {
                showError('Upload failed: ' + error.message);
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const uploadMode = document.getElementById('uploadMode').checked;
            
            let htmlFile;
            if (uploadMode) {
                const fileInput = document.getElementById('fileUpload');
                if (!fileInput.files[0]) {
                    showError('Please select an HTML file to upload');
                    return;
                }
                // File was already uploaded, use the selected option
                htmlFile = document.getElementById('htmlFile').value;
            } else {
                htmlFile = document.getElementById('htmlFile').value;
            }

            if (!htmlFile) {
                showError('Please select an HTML file');
                return;
            }

            const config = {
                htmlFile: htmlFile,
                duration: parseInt(document.getElementById('duration').value),
                fps: parseInt(document.getElementById('fps').value),
                width: parseInt(document.getElementById('width').value),
                height: parseInt(document.getElementById('height').value),
                quality: parseInt(document.getElementById('quality').value),
                selector: document.getElementById('selector').value || 'body',
                enableRecordingControl: document.getElementById('enableRecordingControl').checked,
                waitForStartSignal: document.getElementById('waitForStartSignal').checked
            };

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentJobId = result.jobId;
                    currentVideoPath = result.outputPath;
                    startProgressMonitoring();
                    updateStatus('generating', 'Video generation started...');
                    showProgressContainer();
                    disableForm();
                } else {
                    showError(result.error || 'Failed to start generation');
                }
            } catch (error) {
                showError('Failed to start generation: ' + error.message);
            }
        }

        function startProgressMonitoring() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource(`/api/progress/${currentJobId}`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateProgress(data);
            };

            eventSource.onerror = function(error) {
                console.error('SSE error:', error);
                if (eventSource.readyState === EventSource.CLOSED) {
                    setTimeout(() => {
                        if (currentJobId) {
                            startProgressMonitoring();
                        }
                    }, 5000);
                }
            };
        }

        function updateProgress(data) {
            const { status, progress, message, error, outputPath } = data;
            
            updateStatus(status, message);
            
            if (status === 'generating') {
                if (typeof progress === 'number') {
                    // Fixed duration mode
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('progressText').textContent = message;
                } else {
                    // Recording control mode - show indeterminate progress
                    document.getElementById('progressFill').style.width = '100%';
                    document.getElementById('progressFill').style.animation = 'pulse 2s ease-in-out infinite alternate';
                    document.getElementById('progressText').textContent = message;
                }
            } else if (status === 'completed') {
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressText').textContent = 'Generation completed!';
                showVideoPreview(outputPath);
                loadVideoMetadata(outputPath);
                loadRecentVideos();
                enableForm();
                eventSource.close();
            } else if (status === 'failed') {
                showError(error || 'Generation failed');
                enableForm();
                eventSource.close();
            }
        }

        function updateStatus(status, message) {
            const badge = document.getElementById('statusBadge');
            const messageEl = document.getElementById('statusMessage');
            
            badge.className = `status-badge status-${status}`;
            badge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            messageEl.textContent = message;
        }

        function showProgressContainer() {
            document.getElementById('progressContainer').style.display = 'block';
        }

        function hideProgressContainer() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function showVideoPreview(videoPath) {
            const preview = document.getElementById('videoPreview');
            const video = document.getElementById('videoPlayer');
            
            // Fix path for videos when accessed from /viewers/ directory
            const videoSrc = videoPath.startsWith('/') ? videoPath : '../' + videoPath;
            video.src = videoSrc;
            preview.style.display = 'block';
        }

        async function loadVideoMetadata(videoPath) {
            try {
                const filename = videoPath.split('/').pop();
                const response = await fetch(`/api/metadata/${filename}`);
                
                if (response.ok) {
                    const metadata = await response.json();
                    displayMetadata(metadata);
                }
            } catch (error) {
                console.error('Failed to load metadata:', error);
            }
        }

        function displayMetadata(metadata) {
            const container = document.getElementById('metadataDisplay');
            const grid = document.getElementById('metadataGrid');
            
            const items = [
                { label: 'Generation Time', value: `${metadata.generationTime?.toFixed(1)}s` },
                { label: 'Processing Speed', value: `${metadata.processingSpeed?.toFixed(1)} fps` },
                { label: 'Video Duration', value: `${metadata.duration}s` },
                { label: 'Captured Frames', value: metadata.capturedFrames },
                { label: 'File Size', value: `${metadata.fileSize?.toFixed(1)} MB` },
                { label: 'Resolution', value: `${metadata.width}x${metadata.height}` },
                { label: 'Quality (CRF)', value: metadata.quality },
                { label: 'Time Ratio', value: `${metadata.generationTimeRatio?.toFixed(2)}x` }
            ];

            grid.innerHTML = items.map(item => `
                <div class="metadata-item">
                    <span class="metadata-value">${item.value}</span>
                    <div class="metadata-label">${item.label}</div>
                </div>
            `).join('');

            container.style.display = 'block';
        }

        async function loadRecentVideos() {
            try {
                const response = await fetch('/api/videos');
                const data = await response.json();
                
                const container = document.getElementById('recentVideos');
                
                if (data.videos && data.videos.length > 0) {
                    container.innerHTML = data.videos.slice(0, 5).map(video => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border);">
                            <div>
                                <strong>${video.filename}</strong>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">
                                    ${video.resolution} ‚Ä¢ ${video.duration} ‚Ä¢ ${video.fileSize}
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="openVideo('${video.path}')">
                                    üëÅÔ∏è View
                                </button>
                                <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteVideoFile('${video.filename}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>No videos generated yet.</p>';
                }
            } catch (error) {
                document.getElementById('recentVideos').innerHTML = '<p>Failed to load recent videos.</p>';
            }
        }

        function disableForm() {
            const form = document.getElementById('configForm');
            const inputs = form.querySelectorAll('input, select, button');
            inputs.forEach(input => input.disabled = true);
        }

        function enableForm() {
            const form = document.getElementById('configForm');
            const inputs = form.querySelectorAll('input, select, button');
            inputs.forEach(input => input.disabled = false);
            
            // Re-apply recording control dependencies
            const enableRecording = document.getElementById('enableRecordingControl');
            const waitForSignal = document.getElementById('waitForStartSignal');
            waitForSignal.disabled = !enableRecording.checked;
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        }

        // Video actions
        function downloadVideo() {
            if (currentVideoPath) {
                const link = document.createElement('a');
                // Fix path for downloads when accessed from /viewers/ directory
                const downloadPath = currentVideoPath.startsWith('/') ? currentVideoPath : '../' + currentVideoPath;
                link.href = downloadPath;
                link.download = currentVideoPath.split('/').pop();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function openInViewer() {
            if (currentVideoPath) {
                const url = `view-video.html?video=${encodeURIComponent(currentVideoPath)}`;
                window.open(url, '_blank');
            }
        }

        function deleteVideo() {
            if (currentVideoPath && confirm('Are you sure you want to delete this video?')) {
                deleteVideoFile(currentVideoPath.split('/').pop());
            }
        }

        async function deleteVideoFile(filename) {
            try {
                const response = await fetch(`/api/video/${filename}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showSuccess('Video deleted successfully');
                    loadRecentVideos();
                    
                    // Hide preview if this was the current video
                    if (currentVideoPath && currentVideoPath.includes(filename)) {
                        document.getElementById('videoPreview').style.display = 'none';
                        document.getElementById('metadataDisplay').style.display = 'none';
                        currentVideoPath = null;
                    }
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to delete video');
                }
            } catch (error) {
                showError('Failed to delete video: ' + error.message);
            }
        }

        function openVideo(path) {
            const url = `view-video.html?video=${encodeURIComponent(path)}`;
            window.open(url, '_blank');
        }

        // Theme management
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const toggle = document.querySelector('.theme-toggle');
            toggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            const toggle = document.querySelector('.theme-toggle');
            toggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Load hardware capabilities
        async function loadHardwareCapabilities() {
            try {
                const response = await fetch('/api/hardware-capabilities');
                const capabilities = await response.json();
                
                // Update acceleration dropdown
                const select = document.getElementById('convertAcceleration');
                if (select) {
                    select.innerHTML = '<option value="auto">üöÄ Auto (Recommended)</option>';
                    
                    if (capabilities.available) {
                        capabilities.available.forEach(method => {
                            if (method !== 'cpu') {
                                const option = document.createElement('option');
                                option.value = method;
                                
                                const names = {
                                    nvenc: 'üéÆ NVIDIA NVENC',
                                    videotoolbox: 'üçé Apple VideoToolbox',
                                    qsv: 'üíª Intel Quick Sync',
                                    amf: 'üî¥ AMD AMF'
                                };
                                
                                option.textContent = names[method] || method.toUpperCase();
                                select.appendChild(option);
                            }
                        });
                        
                        // Add CPU option
                        const cpuOption = document.createElement('option');
                        cpuOption.value = 'cpu';
                        cpuOption.textContent = '‚öôÔ∏è CPU Only';
                        select.appendChild(cpuOption);
                    }
                }
                
            } catch (error) {
                console.error('Failed to load hardware capabilities:', error);
            }
        }

        // Video conversion functionality
        let conversionEventSource = null;

        async function convertVideo(format) {
            if (!currentVideoPath) {
                showError('No video available for conversion');
                return;
            }

            const filename = currentVideoPath.split('/').pop();
            
            try {
                // Disable conversion buttons
                document.getElementById('convertMp4Btn').disabled = true;
                document.getElementById('convertMovBtn').disabled = true;
                
                // Show conversion status
                document.getElementById('conversionStatus').style.display = 'block';
                document.getElementById('conversionDownloads').style.display = 'none';
                document.getElementById('conversionProgress').style.width = '0%';
                document.getElementById('conversionMessage').textContent = `Starting ${format.toUpperCase()} conversion...`;

                // Get selected acceleration method
                const accelerationMethod = document.getElementById('convertAcceleration').value;
                const payload = { format };
                if (accelerationMethod !== 'auto') {
                    payload.accelerationMethod = accelerationMethod;
                }

                const response = await fetch(`/api/convert/${filename}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (response.ok) {
                    // Start monitoring conversion progress
                    monitorConversion(result.jobId, result.outputFilename);
                } else {
                    showError(result.error || 'Failed to start conversion');
                    resetConversionButtons();
                }

            } catch (error) {
                showError('Failed to start conversion: ' + error.message);
                resetConversionButtons();
            }
        }

        function monitorConversion(jobId, outputFilename) {
            if (conversionEventSource) {
                conversionEventSource.close();
            }

            conversionEventSource = new EventSource(`/api/progress/${jobId}`);
            
            conversionEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateConversionStatus(data, outputFilename);
            };

            conversionEventSource.onerror = function(error) {
                console.error('Conversion SSE error:', error);
            };
        }

        function updateConversionStatus(data, outputFilename) {
            const { status, progress, message, error } = data;
            
            if (status === 'converting') {
                document.getElementById('conversionProgress').style.width = progress + '%';
                document.getElementById('conversionMessage').textContent = message || 'Converting...';
            } else if (status === 'completed') {
                document.getElementById('conversionProgress').style.width = '100%';
                document.getElementById('conversionMessage').textContent = message || 'Conversion completed!';
                
                // Show download link
                const format = outputFilename.split('.').pop().toUpperCase();
                document.getElementById('conversionDownloads').innerHTML = `
                    <a href="../output/${outputFilename}" download="${outputFilename}" class="btn btn-primary" style="font-size: 14px; padding: 8px 16px;">
                        üíæ Download ${format}
                    </a>
                `;
                document.getElementById('conversionDownloads').style.display = 'block';
                
                showSuccess(`${format} conversion completed!`);
                resetConversionButtons();
                conversionEventSource.close();
            } else if (status === 'failed') {
                showError(error || 'Conversion failed');
                resetConversionButtons();
                conversionEventSource.close();
            }
        }

        function resetConversionButtons() {
            document.getElementById('convertMp4Btn').disabled = false;
            document.getElementById('convertMovBtn').disabled = false;
            
            // Hide conversion status after a delay
            setTimeout(() => {
                document.getElementById('conversionStatus').style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>